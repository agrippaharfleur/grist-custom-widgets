<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de lignes</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 1rem;
            background-color: var(--background-default-grey);
            font-family: Marianne, Arial, sans-serif;
        }
        
        .counter-value {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .counter-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .fr-callout .counter-value,
        .fr-callout .counter-label {
            color: inherit;
        }

        #config {
            display: none;
            background-color: var(--background-default-grey);
            padding: 1rem;
            height: 100%;
            overflow-y: auto;
        }

        #preview {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-default-grey);
        }

        #preview .counter-value {
            font-size: 2rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <!-- Mode normal : affichage du compteur -->
    <div id="container">
        <div class="fr-callout" id="callout">
            <p class="fr-callout__title counter-value" id="rowCount">0</p>
            <p class="counter-label" id="rowLabel">label</p>
        </div>
    </div>

    <!-- Mode configuration -->
    <div id="config">
        <div class="fr-input-group">
            <label class="fr-label" for="labelInput">Texte du label</label>
            <input class="fr-input" type="text" id="labelInput" placeholder="label">
        </div>

        <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="couleurSelect">Couleur du callout</label>
            <select class="fr-select" id="couleurSelect">
                <option value="">défaut</option>
                <option value="green-tilleul-verveine">green-tilleul-verveine</option>
                <option value="green-bourgeon">green-bourgeon</option>
                <option value="green-emeraude">green-emeraude</option>
                <option value="green-menthe">green-menthe</option>
                <option value="green-archipel">green-archipel</option>
                <option value="blue-ecume">blue-ecume</option>
                <option value="blue-cumulus">blue-cumulus</option>
                <option value="purple-glycine">purple-glycine</option>
                <option value="pink-macaron">pink-macaron</option>
                <option value="pink-tuile">pink-tuile</option>
                <option value="yellow-tournesol">yellow-tournesol</option>
                <option value="yellow-moutarde">yellow-moutarde</option>
                <option value="orange-terre-battue">orange-terre-battue</option>
                <option value="brown-cafe-creme">brown-cafe-creme</option>
                <option value="brown-caramel">brown-caramel</option>
                <option value="brown-opera">brown-opera</option>
                <option value="beige-gris-galet">beige-gris-galet</option>
            </select>
        </div>

        <div class="fr-select-group fr-mt-2w" id="calculGroup">
            <label class="fr-label" for="calculSelect">Type de calcul</label>
            <select class="fr-select" aria-describedby="calcul-messages" id="calculSelect">
                <option value="row-count" selected>Compteur de lignes</option>
                <optgroup label="Tous les champs">
                    <option value="empty">Vide</option>
                    <option value="filled">Rempli</option>
                    <option value="unique">Unique</option>
                    <option value="percent-empty">% Vide</option>
                    <option value="percent-filled">% Rempli</option>
                </optgroup>
                <optgroup label="Champs numériques uniquement" id="numericGroup">
                    <option value="sum">Somme</option>
                    <option value="average">Moyenne</option>
                    <option value="median">Médiane</option>
                    <option value="min">Minimum</option>
                    <option value="max">Maximum</option>
                </optgroup>
            </select>
            
            <div class="fr-messages-group" id="calcul-messages" aria-live="polite">
                <!-- Message affiché quand aucune colonne n'est mappée -->
                <p class="fr-message fr-message--info" id="no-column-message" style="display: none;">
                    Aucune colonne sélectionnée. Le compteur affiche le nombre total de lignes.
                </p>
                <!-- Message affiché quand la colonne n'est pas numérique -->
                <p class="fr-message fr-message--info" id="non-numeric-message" style="display: none;">
                    La colonne sélectionnée n'est pas numérique. Les calculs numériques sont désactivés.
                </p>
            </div>
        </div>

        <div class="fr-checkbox-group fr-mt-2w" id="euroCheckboxGroup">
            <input type="checkbox" id="euroCheckbox">
            <label class="fr-label" for="euroCheckbox">Afficher le symbole € (pour les calculs numériques)</label>
        </div>

        <div class="button-group fr-mt-2w">
            <button class="fr-btn" onclick="saveOptions()">Enregistrer</button>
            <button class="fr-btn fr-btn--secondary" onclick="cancelOptions()">Annuler</button>
        </div>

        <!-- Prévisualisation -->
        <div id="preview">
            <p class="fr-text--sm fr-text--bold fr-mb-1w">Prévisualisation :</p>
            <div class="fr-callout" id="previewCallout">
                <p class="fr-callout__title counter-value" id="previewCount">42</p>
                <p class="counter-label" id="previewLabel">label</p>
            </div>
        </div>
    </div>

    <!-- DSFR JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js" nomodule></script>
    
    <script>
        // Module de sécurité
        function echapperHTML(texte) {
            if (!texte && texte !== 0) return '';
            const div = document.createElement('div');
            div.textContent = String(texte);
            return div.innerHTML;
        }
        
        function formaterNombre(nombre, typeCalcul, avecEuro = false) {
            if (typeof nombre !== 'number' || isNaN(nombre)) return '0';
            
            const formatted = nombre.toLocaleString('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
            
            // Ajouter % pour les calculs de pourcentage
            if (typeCalcul && typeCalcul.startsWith('percent-')) {
                return formatted + ' %';
            }
            
            // Ajouter € si demandé
            return avecEuro ? formatted + ' €' : formatted;
        }
        
        console.log('✓ Module de sécurité chargé');
        
        // Variables globales
        let currentLabel = "label";
        let currentCouleur = "";
        let currentCalcul = "row-count";
        let currentEuro = false;
        let currentRecords = [];
        let hasColumnMapping = false;
        let isNumericColumn = false;
        
        // Vérifier si la colonne est numérique
        function detecterTypeColonne(records) {
            if (!records || records.length === 0 || !hasColumnMapping) {
                return false;
            }
            
            const mapped = grist.mapColumnNames(records);
            
            // Vérifier les premières valeurs non-nulles
            for (let i = 0; i < Math.min(10, mapped.length); i++) {
                const value = mapped[i].ColonneCalcul;
                if (value != null && value !== '') {
                    // Si on trouve une valeur, tester si c'est un nombre
                    return typeof value === 'number' || !isNaN(parseFloat(value));
                }
            }
            
            // Par défaut, considérer comme non-numérique si aucune valeur trouvée
            return false;
        }
        
        // Gérer la visibilité de la checkbox €
        function updateEuroCheckboxVisibility() {
            const calculSelect = document.getElementById('calculSelect');
            const euroCheckboxGroup = document.getElementById('euroCheckboxGroup');
            const typeCalcul = calculSelect.value;
            
            // Masquer si c'est un calcul de pourcentage
            if (typeCalcul.startsWith('percent-')) {
                euroCheckboxGroup.style.display = 'none';
            } else {
                euroCheckboxGroup.style.display = 'block';
            }
        }
        
        // Gérer l'état du select de calcul selon le mapping
        function updateCalculSelectState() {
            const calculSelect = document.getElementById('calculSelect');
            const noColumnMessage = document.getElementById('no-column-message');
            const nonNumericMessage = document.getElementById('non-numeric-message');
            const calculGroup = document.getElementById('calculGroup');
            
            // Réinitialiser tous les états
            Array.from(calculSelect.options).forEach(option => {
                option.disabled = false;
            });
            noColumnMessage.style.display = 'none';
            nonNumericMessage.style.display = 'none';
            calculGroup.classList.remove('fr-select-group--info');
            
            if (!hasColumnMapping) {
                // Aucune colonne mappée : bloquer tout sauf "Compteur de lignes"
                Array.from(calculSelect.options).forEach(option => {
                    if (option.value !== 'row-count') {
                        option.disabled = true;
                    }
                });
                
                // Forcer la sélection sur "Compteur de lignes"
                calculSelect.value = 'row-count';
                currentCalcul = 'row-count';
                
                // Afficher le message
                noColumnMessage.style.display = 'block';
                calculGroup.classList.add('fr-select-group--info');
                
            } else if (!isNumericColumn) {
                // Colonne non-numérique : bloquer les calculs numériques
                const numericCalculs = ['sum', 'average', 'median', 'min', 'max'];
                Array.from(calculSelect.options).forEach(option => {
                    if (numericCalculs.includes(option.value)) {
                        option.disabled = true;
                    }
                });
                
                // Si le calcul actuel est numérique, revenir à "Compteur de lignes"
                if (numericCalculs.includes(calculSelect.value)) {
                    calculSelect.value = 'row-count';
                    currentCalcul = 'row-count';
                }
                
                // Afficher le message
                nonNumericMessage.style.display = 'block';
                calculGroup.classList.add('fr-select-group--info');
            }
            
            // Mettre à jour la visibilité de la checkbox €
            updateEuroCheckboxVisibility();
        }
        
        // Fonctions de calcul
        function calculerValeur(records, typeCalcul) {
            if (!records || records.length === 0) return 0;
            
            // Compteur de lignes : toujours compter toutes les lignes
            if (typeCalcul === 'row-count') {
                return records.length;
            }
            
            const mapped = grist.mapColumnNames(records);
            
            switch(typeCalcul) {
                case 'empty': {
                    return mapped.filter(r => r.ColonneCalcul == null || r.ColonneCalcul === '').length;
                }
                case 'filled': {
                    return mapped.filter(r => r.ColonneCalcul != null && r.ColonneCalcul !== '').length;
                }
                case 'unique': {
                    const values = mapped.map(r => r.ColonneCalcul).filter(v => v != null && v !== '');
                    return new Set(values).size;
                }
                case 'percent-empty': {
                    const empty = mapped.filter(r => r.ColonneCalcul == null || r.ColonneCalcul === '').length;
                    return parseFloat((empty / records.length * 100).toFixed(1));
                }
                case 'percent-filled': {
                    const filled = mapped.filter(r => r.ColonneCalcul != null && r.ColonneCalcul !== '').length;
                    return parseFloat((filled / records.length * 100).toFixed(1));
                }
                case 'sum': {
                    return mapped.reduce((sum, r) => {
                        const val = parseFloat(r.ColonneCalcul);
                        return sum + (isNaN(val) ? 0 : val);
                    }, 0);
                }
                case 'average': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v));
                    return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                }
                case 'median': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v)).sort((a, b) => a - b);
                    if (values.length === 0) return 0;
                    const mid = Math.floor(values.length / 2);
                    return values.length % 2 === 0 ? (values[mid - 1] + values[mid]) / 2 : values[mid];
                }
                case 'min': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v));
                    return values.length > 0 ? Math.min(...values) : 0;
                }
                case 'max': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v));
                    return values.length > 0 ? Math.max(...values) : 0;
                }
                default:
                    return records.length;
            }
        }
        
        // Mise à jour de la prévisualisation
        function updatePreview() {
            const label = document.getElementById("labelInput").value || "label";
            const couleur = document.getElementById("couleurSelect").value;
            const calcul = document.getElementById("calculSelect").value;
            const euro = document.getElementById("euroCheckbox").checked;
            
            const previewCallout = document.getElementById('previewCallout');
            const previewLabel = document.getElementById('previewLabel');
            const previewCount = document.getElementById('previewCount');
            
            // Appliquer la couleur
            previewCallout.className = 'fr-callout';
            if (couleur) {
                previewCallout.classList.add('fr-callout--' + couleur);
            }
            
            // Appliquer le label
            previewLabel.textContent = echapperHTML(label);
            
            // Appliquer le format du nombre selon le type de calcul
            let exampleValue = 42;
            if (calcul.startsWith('percent-')) {
                exampleValue = 75.5; // Exemple pour les pourcentages
            }
            
            previewCount.textContent = formaterNombre(exampleValue, calcul, euro);
        }
        
        // Ajouter les listeners pour la prévisualisation en temps réel
        function setupPreviewListeners() {
            document.getElementById("labelInput").addEventListener('input', updatePreview);
            document.getElementById("couleurSelect").addEventListener('change', updatePreview);
            document.getElementById("calculSelect").addEventListener('change', function() {
                updateEuroCheckboxVisibility();
                updatePreview();
            });
            document.getElementById("euroCheckbox").addEventListener('change', updatePreview);
        }
        
        // Fermer le panneau de configuration
        function closeConfigPanel() {
            document.getElementById("container").style.display = 'block';
            document.getElementById("config").style.display = 'none';
            grist.widgetApi.clearOptions();
        }
        
        // Sauvegarder les options
        function saveOptions() {
            const label = document.getElementById("labelInput").value;
            const couleur = document.getElementById("couleurSelect").value;
            const calcul = document.getElementById("calculSelect").value;
            const euro = document.getElementById("euroCheckbox").checked;
            
            grist.widgetApi.setOption('label', label);
            grist.widgetApi.setOption('couleur', couleur);
            grist.widgetApi.setOption('calcul', calcul);
            grist.widgetApi.setOption('euro', euro);
            
            // Fermer le panneau après sauvegarde
            closeConfigPanel();
        }
        
        // Annuler les modifications
        function cancelOptions() {
            closeConfigPanel();
        }
        
        // Appliquer les options
        function appliquerOptions(options) {
            const callout = document.getElementById('callout');
            const labelElement = document.getElementById('rowLabel');
            
            options = options || {};
            
            // Utiliser !== undefined pour permettre les valeurs vides
            currentLabel = options.label !== undefined ? options.label : "label";
            currentCouleur = options.couleur !== undefined ? options.couleur : "";
            currentCalcul = options.calcul !== undefined ? options.calcul : "row-count";
            currentEuro = options.euro !== undefined ? options.euro : false;
            
            // Si pas de colonne mappée, forcer "row-count"
            if (!hasColumnMapping && currentCalcul !== 'row-count') {
                currentCalcul = 'row-count';
                grist.widgetApi.setOption('calcul', 'row-count');
            }
            
            // Si colonne non-numérique et calcul numérique, forcer "row-count"
            const numericCalculs = ['sum', 'average', 'median', 'min', 'max'];
            if (!isNumericColumn && numericCalculs.includes(currentCalcul)) {
                currentCalcul = 'row-count';
                grist.widgetApi.setOption('calcul', 'row-count');
            }
            
            // Appliquer le label
            labelElement.textContent = echapperHTML(currentLabel);
            
            // Appliquer la couleur
            callout.className = 'fr-callout';
            if (currentCouleur) {
                callout.classList.add('fr-callout--' + currentCouleur);
            }
            
            // Recalculer avec les nouveaux paramètres
            if (currentRecords.length > 0) {
                mettreAJourCompteur(currentRecords);
            }
        }
        
        // Mettre à jour le compteur
        function mettreAJourCompteur(records) {
            currentRecords = records;
            const valeur = calculerValeur(records, currentCalcul);
            const formattedCount = formaterNombre(valeur, currentCalcul, currentEuro);
            document.getElementById('rowCount').textContent = echapperHTML(formattedCount);
        }
        
        // Initialisation Grist
        function initGrist() {
            grist.ready({ 
                columns: [{ 
                    name: "ColonneCalcul", 
                    title: 'Colonne pour le calcul', 
                    type: 'Any',
                    optional: true,
                    description: 'Colonne sur laquelle effectuer le calcul (optionnel pour "Compteur de lignes")'
                }],
                requiredAccess: 'read table',
                allowSelectBy: true,
                onEditOptions() {
                    // Passer en mode configuration
                    document.getElementById("container").style.display = 'none';
                    document.getElementById("config").style.display = 'block';
                    
                    // Pré-remplir les champs avec les valeurs actuelles
                    document.getElementById("labelInput").value = currentLabel;
                    document.getElementById("couleurSelect").value = currentCouleur;
                    document.getElementById("calculSelect").value = currentCalcul;
                    document.getElementById("euroCheckbox").checked = currentEuro;
                    
                    // Mettre à jour l'état du select selon le mapping
                    updateCalculSelectState();
                    
                    // Mettre à jour la prévisualisation
                    updatePreview();
                }
            });
            
            // Charger les options
            grist.onOptions((customOptions) => {
                customOptions = customOptions || {};
                
                // Repasser en mode normal
                document.getElementById("container").style.display = 'block';
                document.getElementById("config").style.display = 'none';
                
                // Appliquer les options
                appliquerOptions(customOptions);
            });
            
            // Mise à jour du compteur
            grist.onRecords(function(records, mappings) {
                // Détecter si une colonne est mappée
                hasColumnMapping = mappings && mappings.ColonneCalcul !== undefined && mappings.ColonneCalcul !== null;
                
                // Détecter si la colonne est numérique
                isNumericColumn = detecterTypeColonne(records);
                
                mettreAJourCompteur(records || []);
            });
        }
        
        // Initialiser au chargement du DOM
        document.addEventListener('DOMContentLoaded', function() {
            initGrist();
            setupPreviewListeners();
        });
    </script>
</body>
</html>