<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de lignes</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 1rem;
            background-color: var(--background-default-grey);
            font-family: Marianne, Arial, sans-serif;
        }
        
        .counter-value {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .counter-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .fr-callout .counter-value,
        .fr-callout .counter-label {
            color: inherit;
        }

        #config {
            display: none;
            background-color: var(--background-default-grey);
            padding: 1rem;
            height: 100%;
            overflow-y: auto;
        }

        #preview {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-default-grey);
        }

        #preview .counter-value {
            font-size: 2rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
        
        .fr-alert {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Mode normal : affichage du compteur -->
    <div id="container">
        <div class="fr-callout" id="callout">
            <p class="fr-callout__title counter-value" id="rowCount">0</p>
            <p class="counter-label" id="rowLabel">label</p>
        </div>
    </div>

    <!-- Mode configuration -->
    <div id="config">
        <div class="fr-input-group">
            <label class="fr-label" for="labelInput">Texte du label</label>
            <input class="fr-input" type="text" id="labelInput" placeholder="label">
        </div>

        <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="couleurSelect">Couleur du callout</label>
            <select class="fr-select" id="couleurSelect">
                <option value="">défaut</option>
                <option value="green-tilleul-verveine">green-tilleul-verveine</option>
                <option value="green-bourgeon">green-bourgeon</option>
                <option value="green-emeraude">green-emeraude</option>
                <option value="green-menthe">green-menthe</option>
                <option value="green-archipel">green-archipel</option>
                <option value="blue-ecume">blue-ecume</option>
                <option value="blue-cumulus">blue-cumulus</option>
                <option value="purple-glycine">purple-glycine</option>
                <option value="pink-macaron">pink-macaron</option>
                <option value="pink-tuile">pink-tuile</option>
                <option value="yellow-tournesol">yellow-tournesol</option>
                <option value="yellow-moutarde">yellow-moutarde</option>
                <option value="orange-terre-battue">orange-terre-battue</option>
                <option value="brown-cafe-creme">brown-cafe-creme</option>
                <option value="brown-caramel">brown-caramel</option>
                <option value="brown-opera">brown-opera</option>
                <option value="beige-gris-galet">beige-gris-galet</option>
            </select>
        </div>

        <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="calculSelect">Type de calcul</label>
            <select class="fr-select" id="calculSelect">
                <optgroup label="Tous les champs">
                    <option value="empty">Vide</option>
                    <option value="filled" selected>Rempli</option>
                    <option value="unique">Unique</option>
                    <option value="percent-empty">% Vide</option>
                    <option value="percent-filled">% Rempli</option>
                </optgroup>
                <optgroup label="Champs numériques uniquement">
                    <option value="sum">Somme</option>
                    <option value="average">Moyenne</option>
                    <option value="median">Médiane</option>
                    <option value="min">Minimum</option>
                    <option value="max">Maximum</option>
                </optgroup>
            </select>
            
            <!-- Message d'information si aucune colonne mappée -->
            <div class="fr-alert fr-alert--info fr-alert--sm" id="noColumnWarning" style="display: none;">
                <p class="fr-alert__title">Aucune colonne sélectionnée</p>
                <p>Utilisez le panneau "Select By" pour choisir une colonne. Sans colonne, seul le calcul "Rempli" est disponible et compte le nombre total de lignes.</p>
            </div>
            
            <!-- Message normal -->
            <p class="fr-hint-text" id="normalHint">Utiliser le panneau "Select By" pour choisir la colonne à calculer</p>
        </div>

        <div class="fr-checkbox-group fr-mt-2w">
            <input type="checkbox" id="euroCheckbox">
            <label class="fr-label" for="euroCheckbox">Afficher le symbole € (pour les calculs numériques)</label>
        </div>

        <div class="button-group fr-mt-2w">
            <button class="fr-btn" onclick="saveOptions()">Enregistrer</button>
            <button class="fr-btn fr-btn--secondary" onclick="cancelOptions()">Annuler</button>
        </div>

        <!-- Prévisualisation -->
        <div id="preview">
            <p class="fr-text--sm fr-text--bold fr-mb-1w">Prévisualisation :</p>
            <div class="fr-callout" id="previewCallout">
                <p class="fr-callout__title counter-value" id="previewCount">42</p>
                <p class="counter-label" id="previewLabel">label</p>
            </div>
        </div>
    </div>

    <!-- DSFR JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js" nomodule></script>
    
    <script>
        // Module de sécurité
        function echapperHTML(texte) {
            if (!texte && texte !== 0) return '';
            const div = document.createElement('div');
            div.textContent = String(texte);
            return div.innerHTML;
        }
        
        function formaterNombre(nombre, typeCalcul, avecEuro = false) {
            if (typeof nombre !== 'number' || isNaN(nombre)) return '0';
            
            const formatted = nombre.toLocaleString('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
            
            // Ajouter % pour les calculs de pourcentage
            if (typeCalcul && typeCalcul.startsWith('percent-')) {
                return formatted + ' %';
            }
            
            // Ajouter € si demandé
            return avecEuro ? formatted + ' €' : formatted;
        }
        
        console.log('✓ Module de sécurité chargé');
        
        // Variables globales
        let currentLabel = "label";
        let currentCouleur = "";
        let currentCalcul = "filled";
        let currentEuro = false;
        let currentRecords = [];
        let hasColumnMapping = false;
        
        // Gérer l'état du select de calcul selon le mapping
        function updateCalculSelectState() {
            const calculSelect = document.getElementById('calculSelect');
            const noColumnWarning = document.getElementById('noColumnWarning');
            const normalHint = document.getElementById('normalHint');
            
            if (!hasColumnMapping) {
                // Bloquer tous les calculs sauf "Rempli"
                Array.from(calculSelect.options).forEach(option => {
                    if (option.value !== 'filled') {
                        option.disabled = true;
                    }
                });
                
                // Forcer la sélection sur "Rempli"
                calculSelect.value = 'filled';
                
                // Afficher le message d'avertissement
                noColumnWarning.style.display = 'block';
                normalHint.style.display = 'none';
            } else {
                // Débloquer tous les calculs
                Array.from(calculSelect.options).forEach(option => {
                    option.disabled = false;
                });
                
                // Masquer le message d'avertissement
                noColumnWarning.style.display = 'none';
                normalHint.style.display = 'block';
            }
        }
        
        // Fonctions de calcul
        function calculerValeur(records, typeCalcul) {
            if (!records || records.length === 0) return 0;
            
            const mapped = grist.mapColumnNames(records);
            
            switch(typeCalcul) {
                case 'empty': {
                    return mapped.filter(r => r.ColonneCalcul == null || r.ColonneCalcul === '').length;
                }
                case 'filled': {
                    // Si pas de colonne mappée, compte toutes les lignes
                    if (!hasColumnMapping) {
                        return records.length;
                    }
                    return mapped.filter(r => r.ColonneCalcul != null && r.ColonneCalcul !== '').length;
                }
                case 'unique': {
                    const values = mapped.map(r => r.ColonneCalcul).filter(v => v != null && v !== '');
                    return new Set(values).size;
                }
                case 'percent-empty': {
                    const empty = mapped.filter(r => r.ColonneCalcul == null || r.ColonneCalcul === '').length;
                    return parseFloat((empty / records.length * 100).toFixed(1));
                }
                case 'percent-filled': {
                    const filled = mapped.filter(r => r.ColonneCalcul != null && r.ColonneCalcul !== '').length;
                    return parseFloat((filled / records.length * 100).toFixed(1));
                }
                case 'sum': {
                    return mapped.reduce((sum, r) => {
                        const val = parseFloat(r.ColonneCalcul);
                        return sum + (isNaN(val) ? 0 : val);
                    }, 0);
                }
                case 'average': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v));
                    return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                }
                case 'median': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v)).sort((a, b) => a - b);
                    if (values.length === 0) return 0;
                    const mid = Math.floor(values.length / 2);
                    return values.length % 2 === 0 ? (values[mid - 1] + values[mid]) / 2 : values[mid];
                }
                case 'min': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v));
                    return values.length > 0 ? Math.min(...values) : 0;
                }
                case 'max': {
                    const values = mapped.map(r => parseFloat(r.ColonneCalcul)).filter(v => !isNaN(v));
                    return values.length > 0 ? Math.max(...values) : 0;
                }
                default:
                    return records.length;
            }
        }
        
        // Mise à jour de la prévisualisation
        function updatePreview() {
            const label = document.getElementById("labelInput").value || "label";
            const couleur = document.getElementById("couleurSelect").value;
            const calcul = document.getElementById("calculSelect").value;
            const euro = document.getElementById("euroCheckbox").checked;
            
            const previewCallout = document.getElementById('previewCallout');
            const previewLabel = document.getElementById('previewLabel');
            const previewCount = document.getElementById('previewCount');
            
            // Appliquer la couleur
            previewCallout.className = 'fr-callout';
            if (couleur) {
                previewCallout.classList.add('fr-callout--' + couleur);
            }
            
            // Appliquer le label
            previewLabel.textContent = echapperHTML(label);
            
            // Appliquer le format du nombre selon le type de calcul
            let exampleValue = 42;
            if (calcul.startsWith('percent-')) {
                exampleValue = 75.5; // Exemple pour les pourcentages
            }
            
            previewCount.textContent = formaterNombre(exampleValue, calcul, euro);
        }
        
        // Ajouter les listeners pour la prévisualisation en temps réel
        function setupPreviewListeners() {
            document.getElementById("labelInput").addEventListener('input', updatePreview);
            document.getElementById("couleurSelect").addEventListener('change', updatePreview);
            document.getElementById("calculSelect").addEventListener('change', updatePreview);
            document.getElementById("euroCheckbox").addEventListener('change', updatePreview);
        }
        
        // Fermer le panneau de configuration
        function closeConfigPanel() {
            document.getElementById("container").style.display = 'block';
            document.getElementById("config").style.display = 'none';
            grist.widgetApi.clearOptions();
        }
        
        // Sauvegarder les options
        function saveOptions() {
            const label = document.getElementById("labelInput").value;
            const couleur = document.getElementById("couleurSelect").value;
            const calcul = document.getElementById("calculSelect").value;
            const euro = document.getElementById("euroCheckbox").checked;
            
            grist.widgetApi.setOption('label', label);
            grist.widgetApi.setOption('couleur', couleur);
            grist.widgetApi.setOption('calcul', calcul);
            grist.widgetApi.setOption('euro', euro);
            
            // Fermer le panneau après sauvegarde
            closeConfigPanel();
        }
        
        // Annuler les modifications
        function cancelOptions() {
            closeConfigPanel();
        }
        
        // Appliquer les options
        function appliquerOptions(options) {
            const callout = document.getElementById('callout');
            const labelElement = document.getElementById('rowLabel');
            
            options = options || {};
            
            // Utiliser !== undefined pour permettre les valeurs vides
            currentLabel = options.label !== undefined ? options.label : "label";
            currentCouleur = options.couleur !== undefined ? options.couleur : "";
            currentCalcul = options.calcul !== undefined ? options.calcul : "filled";
            currentEuro = options.euro !== undefined ? options.euro : false;
            
            // Appliquer le label
            labelElement.textContent = echapperHTML(currentLabel);
            
            // Appliquer la couleur
            callout.className = 'fr-callout';
            if (currentCouleur) {
                callout.classList.add('fr-callout--' + currentCouleur);
            }
            
            // Recalculer avec les nouveaux paramètres
            if (currentRecords.length > 0) {
                mettreAJourCompteur(currentRecords);
            }
        }
        
        // Mettre à jour le compteur
        function mettreAJourCompteur(records) {
            currentRecords = records;
            const valeur = calculerValeur(records, currentCalcul);
            const formattedCount = formaterNombre(valeur, currentCalcul, currentEuro);
            document.getElementById('rowCount').textContent = echapperHTML(formattedCount);
        }
        
        // Initialisation Grist
        function initGrist() {
            grist.ready({ 
                columns: [{ 
                    name: "ColonneCalcul", 
                    title: 'Colonne pour le calcul', 
                    type: 'Any',
                    optional: true,
                    description: 'Colonne sur laquelle effectuer le calcul (optionnel pour "Rempli")'
                }],
                requiredAccess: 'read table',
                allowSelectBy: true,
                onEditOptions() {
                    // Passer en mode configuration
                    document.getElementById("container").style.display = 'none';
                    document.getElementById("config").style.display = 'block';
                    
                    // Pré-remplir les champs avec les valeurs actuelles
                    document.getElementById("labelInput").value = currentLabel;
                    document.getElementById("couleurSelect").value = currentCouleur;
                    document.getElementById("calculSelect").value = currentCalcul;
                    document.getElementById("euroCheckbox").checked = currentEuro;
                    
                    // Mettre à jour l'état du select selon le mapping
                    updateCalculSelectState();
                    
                    // Mettre à jour la prévisualisation
                    updatePreview();
                }
            });
            
            // Charger les options
            grist.onOptions((customOptions) => {
                customOptions = customOptions || {};
                
                // Repasser en mode normal
                document.getElementById("container").style.display = 'block';
                document.getElementById("config").style.display = 'none';
                
                // Appliquer les options
                appliquerOptions(customOptions);
            });
            
            // Mise à jour du compteur
            grist.onRecords(function(records, mappings) {
                // Détecter si une colonne est mappée
                hasColumnMapping = mappings && mappings.ColonneCalcul !== undefined && mappings.ColonneCalcul !== null;
                
                mettreAJourCompteur(records || []);
            });
        }
        
        // Initialiser au chargement du DOM
        document.addEventListener('DOMContentLoaded', function() {
            initGrist();
            setupPreviewListeners();
        });
    </script>
</body>
</html>