<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de lignes</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 1rem;
            background-color: var(--background-default-grey);
        }
        
        .counter-value {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .counter-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .fr-callout .counter-value,
        .fr-callout .counter-label {
            color: inherit;
        }

        #config {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Mode normal : affichage du compteur -->
    <div id="container">
        <div class="fr-callout" id="callout">
            <p class="fr-callout__title counter-value" id="rowCount">0</p>
            <p class="counter-label" id="rowLabel">Commandes en brouillon</p>
        </div>
    </div>

    <!-- Mode configuration -->
    <div id="config">
        <div class="fr-input-group">
            <label class="fr-label" for="labelInput">Texte du label</label>
            <input class="fr-input" type="text" id="labelInput" placeholder="Commandes en brouillon">
        </div>

        <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="couleurSelect">Couleur du callout</label>
            <select class="fr-select" id="couleurSelect">
                <option value="">Gris (défaut)</option>
                <option value="blue-france">Bleu France</option>
                <option value="green-tilleul-verveine">Vert tilleul verveine</option>
                <option value="green-bourgeon">Vert bourgeon</option>
                <option value="green-emeraude">Vert émeraude</option>
                <option value="green-menthe">Vert menthe</option>
                <option value="green-archipel">Vert archipel</option>
                <option value="blue-ecume">Bleu écume</option>
                <option value="blue-cumulus">Bleu cumulus</option>
                <option value="purple-glycine">Violet glycine</option>
                <option value="pink-macaron">Rose macaron</option>
                <option value="pink-tuile">Rose tuile (rouge)</option>
                <option value="yellow-tournesol">Jaune tournesol</option>
                <option value="yellow-moutarde">Jaune moutarde</option>
                <option value="orange-terre-battue">Orange terre battue</option>
                <option value="brown-cafe-creme">Brun café crème</option>
                <option value="brown-caramel">Brun caramel</option>
                <option value="brown-opera">Brun opéra</option>
                <option value="beige-gris-galet">Beige gris galet</option>
            </select>
        </div>

        <button class="fr-btn fr-mt-2w" onclick="saveOptions()">Enregistrer</button>
    </div>

    <!-- DSFR JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js" nomodule></script>
    
    <script>
        // Module de sécurité
        function echapperHTML(texte) {
            if (!texte && texte !== 0) return '';
            const div = document.createElement('div');
            div.textContent = String(texte);
            return div.innerHTML;
        }
        
        function formaterNombre(nombre) {
            if (typeof nombre !== 'number' || isNaN(nombre)) return '0';
            return nombre.toLocaleString('fr-FR');
        }
        
        console.log('✓ Module de sécurité chargé');
        
        // Variables globales pour les options
        let currentLabel = "Commandes en brouillon";
        let currentCouleur = "beige-gris-galet";
        
        // Sauvegarder les options
        function saveOptions() {
            const label = document.getElementById("labelInput").value;
            const couleur = document.getElementById("couleurSelect").value;
            
            grist.widgetApi.setOption('label', label);
            grist.widgetApi.setOption('couleur', couleur);
        }
        
        // Appliquer les options
        function appliquerOptions(options) {
            const callout = document.getElementById('callout');
            const labelElement = document.getElementById('rowLabel');
            
            options = options || {};
            currentLabel = options.label || "Commandes en brouillon";
            currentCouleur = options.couleur || "beige-gris-galet";
            
            // Appliquer le label
            labelElement.textContent = echapperHTML(currentLabel);
            
            // Appliquer la couleur
            callout.className = 'fr-callout';
            if (currentCouleur) {
                callout.classList.add('fr-callout--' + currentCouleur);
            }
        }
        
        // Initialisation Grist
        grist.ready({ 
            requiredAccess: 'read table',
            allowSelectBy: true,
            onEditOptions() {
                // Passer en mode configuration
                document.getElementById("container").style.display = 'none';
                document.getElementById("config").style.display = '';
                
                // Pré-remplir les champs avec les valeurs actuelles
                document.getElementById("labelInput").value = currentLabel;
                document.getElementById("couleurSelect").value = currentCouleur;
            }
        });
        
        // Charger les options
        grist.onOptions((customOptions) => {
            // Repasser en mode normal
            document.getElementById("container").style.display = '';
            document.getElementById("config").style.display = 'none';
            
            // Appliquer les options
            appliquerOptions(customOptions);
        });
        
        // Mise à jour du compteur
        grist.onRecords(function(records) {
            const totalRows = records ? records.length : 0;
            const formattedCount = formaterNombre(totalRows);
            document.getElementById('rowCount').textContent = echapperHTML(formattedCount);
        });
    </script>
</body>
</html>